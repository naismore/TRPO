# ADR 002: Выбор технологии программирования серверной части Такси-сервиса

**Дата:** 23 октября 2023 г.  
**Статус:** Принято  
**Участники:** Архитектурный комитет, Lead Backend Developer, Tech Lead, DevOps Engineer

---

## Контекст

При разработке серверной части нашего Такси-сервиса необходимо выбрать основную технологию программирования. Этот выбор определит:

- **Производительность** системы при высокой нагрузке (до 1000 одновременных заказов)
- **Скорость разработки** и время выхода на рынок
- **Масштабируемость** и поддержку асинхронных операций
- **Стабильность** и отказоустойчивость
- **Наличие квалифицированных разработчиков** на рынке труда
- **Экосистему** библиотек и инструментов для интеграций (платежи, карты, SMS)

**Рассмотренные варианты:**

1. **Java (Spring Boot)** – проверенная временем экосистема, большое сообщество
2. **Kotlin (Ktor/Spring Boot)** – современный язык на JVM с корутинами
3. **Go** – высокая производительность, низкое потребление памяти, встроенная поддержка конкурентности
4. **Python (FastAPI/Django)** – быстрая разработка, богатая экосистема
5. **Node.js (TypeScript)** – событийно-ориентированная архитектура, один язык для фронтенда и бэкенда
6. **C# (.NET Core)** – высокая производительность, сильная типизация

---

## Решение

Выбран **Kotlin с фреймворком Ktor** для микросервисов и **Kotlin Spring Boot** для монолитного ядра.

---

## Обоснование

### 1. **Производительность и масштабируемость**

- **Kotlin корутины** идеально подходят для I/O-bound операций (сеть, БД, внешние API)
- **Минимальные накладные расходы** по сравнению с традиционными потоками Java
- **Ktor** спроектирован для асинхронных, неблокирующих операций
- Поддержка **реактивных потоков** (Kotlin Flow) для обработки событий в реальном времени

### 2. **Безопасность и надёжность**

- **Null-safety** на уровне языка предотвращает NPE (актуально для обработки заказов и платежей)
- **Иммутабельность по умолчанию** (val, data classes) снижает риски параллельных изменений
- **Сильная типизация** помогает избежать ошибок на этапе компиляции

### 3. **Интеграция с гибридной архитектурой**

- **Полная совместимость с Java** – можем использовать любые Java-библиотеки
- **Ktor** для легковесных микросервисов (уведомления, геолокация)
- **Spring Boot** для монолита с готовыми решениями (безопасность, транзакции, ORM)
- **Kotlin Multiplatform** потенциал для общего кода с мобильными приложениями

### 4. **Экономия ресурсов и операционные расходы**

- **Меньшее потребление памяти** по сравнению с Java (благодаря корутинам)
- **Быстрый старт** приложений (актуально для autoscaling)
- **Эффективное использование CPU** при высокой конкуренции

### 5. **Кадровый аспект**

- **Растущая популярность** Kotlin в backend-разработке
- **Java-разработчики** быстро осваивают Kotlin (1-2 недели обучения)
- **Современный инструментарий** (IntelliJ IDEA, Kotlin DSL для конфигураций)

### 6. **Соответствие бизнес-требованиям**

- **PER01-04:** Асинхронная обработка обеспечивает время отклика <1с
- **SCA01-04:** Горизонтальное масштабирование с корутинами
- **SEC01-06:** Безопасность на уровне языка + Spring Security
- **DUR01-04:** Устойчивость к ошибкам с structured concurrency

---

## Недостатки решения

### 1. **Сравнительно молодая экосистема Ktor**

- Меньше готовых решений по сравнению с Spring Boot
- Требуется больше кастомной разработки для enterprise-функций

### 2. **Кривая обучения для команды**

- Разработчикам нужно освоить корутины и реактивные паттерны
- Два фреймворка (Ktor + Spring) увеличивают сложность поддержки

### 3. **Дебаггинг асинхронного кода**

- Стектрейсы корутин менее информативны, чем у потоков
- Требуются специальные инструменты для мониторинга

### 4. **Ограниченный пул senior Kotlin-разработчиков**

- Риск конкуренции за кадры
- Возможная зависимость от key developers

---

## Последствия

### Технические:

1. **Стек технологий серверной части:**
    
    - **Язык:** Kotlin 1.9+
    - **Фреймворки:** Ktor 2.3+, Spring Boot 3.1+
    - **Базы данных:** PostgreSQL (монолит), Redis (кеш), Cassandra (события)
    - **Миграции:** Flyway или Liquibase
    - **API:** REST + GraphQL для админки + gRPC для межсервисного взаимодействия

2. **Архитектурные паттерны:**
    
    - **CQRS** для модуля заказов
    - **Event Sourcing** для аудита и аналитики
    - **Saga Pattern** для распределённых транзакций
    - **Circuit Breaker** для интеграций с внешними сервисами

3. **Инфраструктурные требования:**
    
    - **JVM версия:** OpenJDK 17+ (LTS)
    - **Контейнеризация:** Docker с multi-stage builds
    - **Оркестрация:** Kubernetes с вертикальным автоподбором ресурсов
    - **Мониторинг:** Micrometer + Prometheus + Grafana с Kotlin корутин метриками


### Организационные:

1. **Обучение команды:**
    
    - 2-недельный интенсив по Kotlin и корутинам
    - Парное программирование опытных и новых разработчиков
    - Internal knowledge base с best practices

2. **Процессы разработки:**
    
    - Статический анализ: Detekt + ktlint
    - Тестирование: Kotest + MockK + Testcontainers
    - CI/CD: Kotlin DSL для GitLab CI/GitHub Actions

3. **Риск-менеджмент:**
    
    - Постепенный переход: начать с одного микросервиса на Ktor
    - Фолбэк план: возможность переписать критичный модуль на Java Spring при необходимости
    - Регулярные архитектурные ревью