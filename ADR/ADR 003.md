# ADR 003: Выбор технологии программирования клиентской части Такси-сервиса

**Дата:** 23 октября 2023 г.  
**Статус:** Принято  
**Участники:** Архитектурный комитет, Lead Frontend Developer, Mobile Lead, UX/UI Designer

---

## Контекст

При разработке клиентской части нашего Такси-сервиса необходимо выбрать технологии для:

- **Мобильных приложений** (iOS и Android) для клиентов и водителей
- **Веб-приложения** для административной панели и кабинета клиента
- **Адаптивного веб-интерфейса** для планшетов и десктопов

Критические требования:

- **Нативная производительность** для работы с картами и геолокацией в реальном времени
- **Плавная анимация** и отзывчивый UI
- **Поддержка офлайн-режима** для заказа такси без интернета
- **Кросс-платформенность** для ускорения разработки
- **Безопасность** хранения платежных данных и токенов
- **Масштабируемость** кодовой базы при добавлении новых функций

**Рассмотренные варианты:**

1. **Нативная разработка** – Swift для iOS, Kotlin для Android
2. **React Native** – JavaScript/TypeScript, кросс-платформенность
3. **Flutter** – Dart, собственная графическая библиотека
4. **Кросс-платформенный Kotlin** – Kotlin Multiplatform Mobile (KMM)
5. **Progressive Web App (PWA)** + нативные оболочки

---

## Решение

Выбрана **гибридная стратегия**:

- **Flutter** для мобильных приложений клиентов и водителей    
- **React (TypeScript)** для веб-админки и кабинета клиента
- **Нативные модули** для критичных функций (геолокация, платежи, push-уведомления)

---

## Обоснование

### 1. **Производительность и пользовательский опыт**

- **Flutter** компилируется в нативный код ARM, обеспечивая 60 FPS анимации    
- **Собственный рендерер Skia** минимизирует зависимость от платформы
- **Горячая перезагрузка (Hot Reload)** ускоряет разработку в 3-5 раз
- **Нативные модули** для критичных операций (расчет маршрутов, работа с Bluetooth)

### 2. **Единая кодовая база для мобильных платформ**

- **90% общего кода** между iOS и Android
- **Единая команда разработчиков** вместо раздельных iOS/Android команд
- **Согласованный UI/UX** на обеих платформах
- **Быстрое исправление багов** на всех платформах одновременно

### 3. **Поддержка требований Такси-сервиса**

- **Работа с картами:** Пакеты `google_maps_flutter` и `mapbox_gl` с нативной производительностью
- **Реальное время:** WebSocket и Server-Sent Events через Dart streams
- **Офлайн-режим:** `sqflite` для локального хранения + синхронизация при подключении
- **Платежи:** Нативные интеграции через платформенные каналы (platform channels)

### 4. **Экономическая эффективность**

- **Сокращение команды** на 30-40% по сравнению с раздельными нативными командами
- **Ускорение выхода на рынок** на 2-3 месяца
- **Снижение стоимости поддержки** и обновлений
- **Легкий онбординг** новых разработчиков (Dart проще, чем Swift+Kotlin)

### 5. **Экосистема и сообщество**

- **Активная разработка Google** с четкой roadmap
- **Богатая библиотека пакетов** ([pub.dev](https://pub.dev)) с 25k+ пакетами
- **Крупные компании-адаптеры:** Google Pay, Alibaba, BMW, eBay
- **Стабильные выпуски** каждые 3 месяца

### 6. **Веб-часть: React TypeScript**

- **Зрелая экосистема** для сложных админ-панелей
- **TypeScript** обеспечивает безопасность типов как в Dart    
- **Совместимость с дизайн-системой** через общие токены
- **Легкая интеграция** с Grafana, Kibana и другими аналитическими инструментами

---

## Недостатки решения

### 1. **Размер приложения**

- **Базовый размер APK:** 15-20 MB (против 5-8 MB у нативного)    
- **Решения:** Dynamic delivery, разделение на фичи, tree shaking

### 2. **Ограниченный доступ к новым платформенным API**

- **Задержка в 1-3 месяца** для доступа к новым iOS/Android функциям
- **Решение:** Platform channels для критичных инноваций

### 3. **Сложность отладки нативных модулей**

- **Двойная отладка** (Dart + нативный код)
- **Решение:** Четкое разделение ответственности, интеграционные тесты

### 4. **Риск зависимости от Google**

- **Стратегический риск** одно поставщика    
- **Митигация:** Архитектура с абстракцией, возможность миграции модулей

---

## Последствия

### Технические:
 

Мобильные приложения (Flutter):
- Dart 3.0+ с null-safety
- Flutter 3.10+ 
- State management: Riverpod 2.0
- Локальное хранилище: Hive + sqflite
- Сетевое взаимодействие: Dio + retrofit_dart
- Картография: google_maps_flutter + mapbox_gl

Веб-приложения (React):
- TypeScript 5.0+
- React 18+ с Next.js 14
- State management: Zustand
- UI библиотека: Material-UI / Ant Design
- Графики: Recharts / D3.js

1. **Архитектура приложений:**
    
    - **Чистая архитектура** с четким разделением слоев
    - **Feature-first структура** для масштабируемости
    - **DI через Riverpod** для тестируемости
    - **BLoC/Cubit** для управления состоянием

2. **Инфраструктура:**
    
    - **CI/CD:** Codemagic (специализирован для Flutter) + GitHub Actions
    - **Тестирование:** Flutter Test (unit), Integration Test, Maestro (E2E)
    - **Мониторинг:** Firebase Crashlytics, Sentry, Mixpanel
    - **A/B тесты:** Firebase Remote Config + Feature flags


### Организационные:

1. **Структура команды:**
    
    - **Flutter-разработчики:** 4-5 человек (полный стек)
    - **React-разработчики:** 2-3 человека
    - **Нативные разработчики:** 1 iOS + 1 Android (part-time, для модулей)
    - **QA инженеры:** с опытом кросс-платформенного тестирования

2. **Процессы разработки:**
    
    - **Единый репозиторий** с монорепой (melos/turbo)
    - **Общие дизайн-токены** между Flutter и React
    - **Еженедельные sync-митинги** между мобильной и веб-командами
    - **Совместные code review** для переиспользуемых компонентов

3. **Риск-менеджмент:**
    
    - **Поэтапный rollout:** сначала MVP на Flutter, затем расширение
    - **Фоллбэк план:** критические модули можно переписать на нативный код
    - **Регулярные перформанс-аудиты** и оптимизации


### Бизнес-последствия:

- **Сокращение time-to-market на 40%** (6 vs 10 месяцев для двух платформ)
- **Экономия на разработке $150-200k в год** за счет единой команды
- **Быстрое добавление новых фич** на обе платформы одновременно
- **Согласованный пользовательский опыт** для всех клиентов
- **Инвестиции в обучение** команды Dart/Flutter ($20-30k)
- **Риск производительности** для сложных анимаций (нуждается в валидации)
