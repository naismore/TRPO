# ADR 004: Выбор систем хранения данных для Такси-сервиса

**Дата:** 23 октября 2023 г.  
**Статус:** Принято  
**Участники:** Архитектурный комитет, Lead Backend Developer, Database Architect, DevOps Engineer

---

## Контекст

Для Такси-сервиса необходимо выбрать системы хранения данных, которые обеспечат:

- **Высокую производительность** при работе с геоданными в реальном времени
- **Масштабируемость** для поддержки роста до 500k пользователей
- **Отказоустойчивость** при распределённой архитектуре
- **Поддержку различных типов данных**: реляционные, документы, графы, временные ряды
- **Согласованность данных** в распределённой системе с eventual consistency

**Критические требования из NFR:**

- **PER01-05:** Время отклика <1-3 секунд для всех операций
- **SCA01-06:** Масштабирование до 500k пользователей
- **AVA01:** Доступность 99.9%
- **SEC04:** Полный аудит действий
- **DUR01-04:** Резервное копирование и восстановление

**Рассмотренные варианты:**

1. **PostgreSQL** – реляционная БД с расширениями
2. **MySQL/MariaDB** – традиционная реляционная БД
3. **MongoDB** – документоориентированная БД
4. **Cassandra/ScyllaDB** – распределённая колоночная БД
5. **Redis** – кэш и key-value хранилище
6. **TimescaleDB** – временные ряды на основе PostgreSQL
7. **Neo4j** – графовая БД для маршрутизации

---

## Решение

Выбрана **полиглотная стратегия хранения**:

- **PostgreSQL с TimescaleDB** – основное хранилище (пользователи, заказы, транзакции)
- **Redis** – кэш, сессии, геоданные в реальном времени
- **ScyllaDB** – события, уведомления, временные метрики
- **Neo4j** – графы маршрутов и оптимизации

---

## Обоснование

### 1. **PostgreSQL + TimescaleDB для основного хранилища**

#### **Почему PostgreSQL:**

- **Надёжность и ACID-транзакции:** Критично для финансовых операций и заказов
- **Расширения:** `PostGIS` для гео-запросов, `pg_cron` для планирования
- **JSONB поддержка:** Гибкость для метаданных заказов и пользовательских профилей
- **Сложные запросы:** Оптимизатор запросов для аналитических отчётов
- **Репликация:** Streaming replication для высокой доступности

#### **Почему TimescaleDB:**

- **Временные ряды:** Идеально для отслеживания перемещений такси, метрик производительности
- **Автоматическое партиционирование:** Эффективное хранение временных данных
- **Совместимость:** Полная совместимость с PostgreSQL и экосистемой

### 2. **Redis для реального времени**

#### **Почему Redis:**

- **Геопространственные команды:** `GEOADD`, `GEORADIUS` для поиска ближайших такси
- **Субмиллисекундная задержка:** Критично для обновления позиций на карте
- **Pub/Sub:** Реализация WebSocket-like уведомлений
- **Кэширование:** Кэш для часто запрашиваемых данных (тарифы, водители)
- **Сессии:** Хранение пользовательских сессий

### 3. **ScyllaDB для событийной системы**

#### **Почему ScyllaDB (а не Cassandra):**

- **C++ вместо Java:** Более низкая задержка, меньше GC пауз
- **Linear scalability:** Предсказуемое масштабирование
- **Time-series tables:** Оптимизировано для событий с временными метками
- **Eventual consistency:** Приемлемо для уведомлений и аудита
- **High write throughput:** До 1M операций в секунду на кластере

### 4. **Neo4j для маршрутизации**

#### **Почему Neo4j:**

- **Графовые алгоритмы:** Dijkstra, A* для расчёта маршрутов
- **Сложные связи:** Моделирование дорожной сети с ограничениями
- **Производительность запросов:** Быстрый поиск оптимальных маршрутов
- **Cypher язык:** Выразительный запросов для графов

### 5. **Архитектурное соответствие**

|Компонент|Хранилище|Обоснование|
|---|---|---|
|Пользователи/водители|PostgreSQL|ACID, сложные связи, транзакции|
|Заказы|PostgreSQL|Транзакции, консистентность|
|Геолокация в реальном времени|Redis GEO|Скорость, гео-запросы|
|История перемещений|TimescaleDB|Временные ряды, аналитика|
|События системы|ScyllaDB|Высокая запись, масштабируемость|
|Уведомления|ScyllaDB|Eventual consistency, отказоустойчивость|
|Маршруты и графы|Neo4j|Графовые алгоритмы, связи|
|Кэш тарифов/правил|Redis|Скорость доступа|
|Аудитные логи|PostgreSQL + ScyllaDB|Полнота и производительность|

---

## Недостатки решения

### 1. **Сложность операционного управления**

- **4 разные системы хранения** требуют экспертизы в каждой
- **Разные модели консистентности:** ACID vs eventual
- **Сложность бэкапов и восстановления** разнородных систем

### 2. **Накладные расходы на синхронизацию**

- **Двойная запись** в некоторых сценариях (CQRS паттерн)
- **Сложность транзакций** между разными хранилищами (Saga pattern)
- **Репликация данных** для аналитики и отчётов

### 3. **Кадровые требования**

- **Эксперты по каждой БД** дороже и реже на рынке
- **Сложность найма** full-stack DB инженеров

### 4. **Стоимость инфраструктуры**

- **Лицензии Neo4j Enterprise** для кластера
- **Ресурсы для 4 систем** вместо 1-2

---

## Последствия

### Технические:

1. **Схемы данных и миграции:**
    
    - **PostgreSQL:** Flyway/Liquibase для миграций схемы
    - **ScyllaDB:** управляемые через конфигурацию, миграции через scripts
    - **Neo4j:** миграции через Cypher скрипты
    - **Redis:** схемы не требуются, но нужны скрипты инициализации


PostgreSQL:
  - Master + 2 Read Replicas
  - WAL архивирование
  - Daily logical backups
  - Point-in-time recovery

ScyllaDB:
  - 3-узловой кластер per DC
  - RF=3, CL=LOCAL_QUORUM
  - Incremental backups

Redis:
  - Redis Sentinel для HA
  - RDB + AOF persistence
  - Daily snapshot

Neo4j:
  - Causal cluster (1 core + 2 read replicas)
  - Online backups

1. **Мониторинг и алертинг:**
    
    - **PostgreSQL:** pg_stat_statements, pgBadger
    - **ScyllaDB:** Prometheus + Grafana с ScyllaDB dashboards
    - **Redis:** Redis Insight, метрики через INFO
    - **Neo4j:** Neo4j Metrics, APOC procedures


### Организационные:

1. **Команда поддержки БД:**
    
    - **PostgreSQL DBA:** 1 человек
    - **NoSQL инженер:** 1 человек (ScyllaDB + Redis)
    - **Neo4j специалист:** 0.5 (совмещение)
    - **DevOps с DB опытом:** 2 человека

2. **Процессы разработки:**
    
    - **Моделирование данных** для каждой БД отдельно
    - **Тестирование производительности** всех хранилищ
    - **Документация схем** и требований к консистентности
    - **Регулярные ревью запросов** и индексов

3. **Бюджет и ресурсы:**
    
    - **CapEx:** $50k на начальный кластер
    - **OpEx:** $8-12k/мес на облачную инфраструктуру
    - **Лицензии:** Neo4j Enterprise ~$20k/год
    - **Обучение команды:** $15-20k


### Бизнес-последствия:

- **Производительность:** Субсекундные отклики для критичных операций
- **Масштабируемость:** Поддержка до 1M+ пользователей
- **Надёжность:** 99.99% доступность с правильной настройкой
- **Гибкость:** Разные типы запросов оптимизированы под хранилище
- **Сложность:** Увеличение time-to-market на 15-20%
- **Стоимость:** На 30-40% выше, чем монолитный подход
