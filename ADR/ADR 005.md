
# ADR 005: Выбор картографического сервиса для геолокации и маршрутизации

**Дата:** 23 октября 2023 г.  
**Статус:** Принято  
**Участники:** Head of Product, Lead Backend Developer, Mobile Lead, DevOps Engineer

---

## Контекст

Для Такси-сервиса необходимо выбрать картографический сервис, который обеспечит:

- **Точное позиционирование** такси в реальном времени
- **Оптимальную маршрутизацию** с учетом трафика и ограничений
- **Геокодирование/обратное геокодирование** адресов
- **Поддержку офлайн-карт** для водителей
- **Стоимостную эффективность** при высокой нагрузке (до 1000 одновременных поездок)
- **Глобальное покрытие** с перспективой расширения

**Критические требования:**

- **PER05:** Отображение карты с задержкой ≤3 секунд
- **SCA05:** Поддержка 1000 одновременных поездок
- **Бизнес-требования:** Точность ETA ≤90%, обновление позиций каждые 5 секунд
- **Юридические требвания:** Соблюдение местных законов о геоданных

**Рассмотренные варианты:**

1. **Google Maps Platform** – лидер рынка, наибольшая точность
2. **Mapbox** – гибкая настройка, хорошее соотношение цена/качество
3. **Яндекс.Карты** – лучшее покрытие в СНГ, понимание локальных особенностей
4. **HERE Technologies** – специализированные навигационные решения
5. **OpenStreetMap + собственный движок** – максимальный контроль, высокая сложность
6. **Гибридный подход** – комбинация нескольких сервисов
    

---

## Решение

Выбран **гибридный подход**:

- **Основной сервис: Mapbox** – для основного функционала
- **Резервный сервис: HERE Technologies** – для навигации водителей
- **Геокодирование: Google Maps** – для точного определения адресов
- **Офлайн-карты: Mapbox + собственный кэш**
    

---

## Обоснование

### 1. **Сравнительный анализ сервисов**

|Критерий|Google Maps|Mapbox|Яндекс.Карты|HERE|OSM|
|---|---|---|---|---|---|
|**Точность в СНГ**|8/10|7/10|9/10|8/10|6/10|
|**Стоимость (100k запросов)**|$700|$500|$400|$600|$0|
|**Кастомизация UI**|Ограничена|Высокая|Средняя|Средняя|Полная|
|**Офлайн-поддержка**|Ограничена|Хорошая|Ограничена|Отличная|Отличная|
|**Маршрутизация с трафиком**|Отличная|Хорошая|Отличная|Отличная|Базовая|
|**Геокодирование**|Отличное|Хорошее|Хорошее|Хорошее|Среднее|
|**Глобальное покрытие**|Отличное|Хорошее|СНГ|Отличное|Неравномерное|
|**SLA**|99.9%|99.9%|99.5%|99.9%|Нет|
|**Интеграционная сложность**|Низкая|Низкая|Средняя|Средняя|Высокая|

### 2. Преимущества гибридного подхода

#### **Основной выбор: Mapbox**

- **Гибкая кастомизация:** Можем создать уникальный стиль карт под наш бренд
- **Прозрачное ценообразование:** Pay-as-you-go, нет минимальных платежей
- **Хороший баланс цена/качество:** На 30% дешевле Google при сравнимом качестве
- **Отличные инструменты для разработчиков:** Хорошая документация, SDK для всех платформ
- **Векторные карты:** Быстрая отрисовка, плавный зум
    

#### **Резерв: HERE Technologies**

- **Специализация на навигации:** Лучшие алгоритмы маршрутизации для водителей
- **Офлайн-навигация:** Полнофункциональная навигация без интернета
- **Надежность:** 99.9% SLA, избыточность по регионам
- **Партнерство с автопроизводителями:** Интеграция с автомобильными системами

#### **Геокодирование: Yandex Maps**

- **Лучшая точность:** Особенно для нестандартных адресов
- **Глобальная база:** Актуальные данные по России
- **Place Autocomplete:** Удобный поиск адресов для пользователей

## Недостатки решения

### 1. **Сложность реализации**

- **Три уровня кэширования** с разными конфигурациями
- **Согласованность данных** между уровнями
- **Инвалидация кэша** в распределенной системе

### 2. **Потребление памяти**

- **Дублирование данных** на разных уровнях
- **Memory overhead** для управления кэшем
- **Эвакуация старых записей** под нагрузкой
    

### 3. **Отладка проблем**

- **Сложность определения** на каком уровне проблема
- **Воспроизведение race conditions** в распределенном кэше
- **Мониторинг консистентности** между уровнями

### 4. **Операционные расходы**

- **Управление Redis Cluster**
- **Мониторинг всех уровней**
- **Настройка и тюнинг** параметров кэша

## Последствия:

- **Производительность:** Увеличение скорости ответа в 5-10 раз
- **Масштабируемость:** Поддержка до 1M+ пользователей
- **Надежность:** Отказоустойчивость за счет многоуровневости
- **Экономия:** Снижение нагрузки на БД на 70-80%
- **Сложность:** Увеличение времени разработки на 20%
- **Стоимость:** Дополнительные $1-2k/мес на инфраструктуру
