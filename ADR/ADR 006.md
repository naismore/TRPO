# ADR 006: Выбор стратегии обработки платежей и обеспечения идемпотентности

**Дата:** 23 октября 2023 г.  
**Статус:** Принято  
**Участники:** Head of Product, Lead Backend Developer, Security Architect, Compliance Officer

---

## Контекст

При разработке Такси-сервиса необходимо определить стратегию обработки платежей, которая обеспечит:

- **Безопасность** финансовых транзакций и пользовательских данных
- **Идемпотентность** операций для предотвращения двойных списаний
- **Надёжность** при сбоях сети и временной недоступности платежных шлюзов
- **Соответствие регуляторным требованиям** (PCI DSS, ФЗ-152, GDPR)
- **Масштабируемость** для обработки пиковых нагрузок (1000+ одновременных поездок)

**Критические требования:**

- **SEC01-06:** Соответствие требованиям безопасности
- **AVA01:** Доступность платежной системы 99.9%
- **Бизнес-требования:** Нулевая tolerance на двойные списания
- **Юридические требования:** Соответствие PCI DSS Level 1

**Рассмотренные варианты:**

1. **Прямая интеграция с платежными шлюзами** – простота, но зависимость от провайдеров
2. **Payment Service Provider (PSP) агрегатор** – абстракция от конкретных провайдеров
3. **Собственная платежная система** – максимальный контроль, высокая сложность и регуляторная нагрузка
4. **Гибридный подход** – PSP для основной массы транзакций + прямые интеграции для специфичных случаев

---

## Решение

Выбран **гибридный подход**:

- **Основной PSP: Stripe** – для международных платежей и карточных операций
- **Локальный PSP: YooKassa** – для операций в СНГ и альтернативных способов оплаты
- **Идемпотентность через Idempotency Keys** на всех уровнях системы
- **Saga Pattern с компенсирующими транзакциями** для распределенных транзакций

---

## Обоснование

### 1. **Сравнительный анализ платежных решений**

|Критерий|Stripe|YooKassa|Прямые интеграции|Собственная система|
|---|---|---|---|---|
|**Поддержка СНГ**|Средняя|Отличная|Зависит от банка|Полная|
|**Международные карты**|Отличная|Ограниченная|Зависит от банка|Сложная|
|**Комиссия**|2.9% + $0.30|2.5-3.5%|1.5-2.5%|0.5-1.5%|
|**Время интеграции**|2 недели|3 недели|1-2 месяца|6+ месяцев|
|**PCI DSS compliance**|Включено|Включено|Частично|Требуется сертификация|
|**Альтернативные способы**|Ограничено|Много|Нет|Любые|
|**Risk management**|Продвинутый|Хороший|Базовый|Собственный|
|**Поддержка 24/7**|Отличная|Хорошая|Ограниченная|Собственная|

### 2. **Архитектура платежной системы**

#### **Уровень 1: Payment Gateway Abstraction**

Абстракция над платежными провайдерами, позволяющая легко добавлять новых провайдеров и переключаться между ними.

#### **Уровень 2: Idempotency Layer**

Гарантирует идемпотентность операций через уникальные ключи, хранящиеся в распределенном кэше.

#### **Уровень 3: Transaction Orchestrator**

Управляет распределенными транзакциями через Saga Pattern с компенсирующими операциями.

#### **Уровень 4: Reconciliation Engine**

Автоматическое сверка транзакций с выписками банков и платежных систем.

### 3. **Стратегия идемпотентности**

#### **Idempotency Keys Generation:**

- Генерация на стороне клиента для мобильных приложений
- Хранение в Redis с TTL 24 часа
- Валидация на всех этапах платежного процесса

#### **Retry Strategy:**

- Exponential backoff с jitter для повторных попыток
- Максимум 5 попыток с увеличивающимися интервалами
- Circuit breaker для защиты от сбоев платежных шлюзов

#### **Compensation Transactions:**

- Автоматические возвраты при таймаутах
- Ручное подтверждение для спорных случаев
- Аудит всех компенсирующих операций

### 4. **Обработка edge cases**

#### **Сценарий "Водитель принял заказ, но оплата failed":**

1. Блокировка средств на карте клиента
2. Назначение водителя
3. При неудачной оплате – автоматическая отмена заказа
4. Уведомление водителя о технической проблеме
5. Запись в аудит-лог для ручного разбора

#### **Сценарий "Двойное списание из-за retry":**

1. Проверка idempotency key перед каждой операцией
2. Atomic операции в Redis для проверки состояния
3. Возврат успешного результата при повторном запросе
4. Алерт при обнаружении расхождений

### 5. **Безопасность и комплаенс**

#### **PCI DSS Compliance:**

- Использование токенизации карт
- Никакого хранения PAN данных в нашей системе
- Регулярные security audits и penetration testing
- Сегрегация платежного окружения

#### **Данные пользователей:**

- Шифрование sensitive данных в rest и transit
- Маскирование карточных данных в логах
- Автоматическое удаление старых данных по политике retention

---

## Недостатки решения

### 1. **Сложность реализации**

- Две параллельные интеграции с разными API
- Синхронизация данных между разными платежными системами
- Сложная логика выбора оптимального провайдера

### 2. **Операционные расходы**

- Двойные комиссии при использовании двух PSP
- Сложность reconciliation между разными системами
- Необходимость поддержки экспертизы по двум платформам
    

### 3. **Зависимость от внешних провайдеров**

- Риск изменения условий сотрудничества
- Разные SLA и процедуры эскалации
- Юридические ограничения в разных юрисдикциях

### 4. **Управление рисками**

- Разные fraud detection системы
- Сложность единой аналитики мошенничества
- Разные процедуры chargeback

---

## Последствия

### Технические:

1. **Архитектура Payment Service:**
    
    - Абстракция над Stripe и YooKassa
    - Единый интерфейс для всех операций
    - Автоматический выбор провайдера по правилам
    
2. **Инфраструктура:**
    
    - Изолированный Kubernetes namespace для платежных сервисов
    - Dedicated Redis для хранения idempotency keys
    - Отдельная сеть с усиленным security
    
3. **Мониторинг:**
    
    - Дашборды успешности транзакций по провайдерам
    - Алерты при росте failure rate выше 1%
    - Мониторинг chargeback ratio
    

### Организационные:

1. **Команда:**
    
    - Payment Engineer (1 чел) – интеграции и поддержка
    - Fraud Analyst (0.5 чел) – анализ мошенничества
    - Compliance Officer (0.5 чел) – регуляторные требования
    
2. **Процессы:**
    
    - Ежедневная сверка транзакций
    - Еженедельные review chargeback
    - Ежемесячные security audits
    
3. **Бюджет:**
    
    - Комиссии: 2.5-3% от оборота
    - Инфраструктура: $500-1000/мес
    - Персонал: $120k/год
    

### Бизнес-последствия:

- **Глобальное покрытие:** Поддержка международных и локальных платежей
- **Надёжность:** Минимальный риск двойных списаний
- **Безопасность:** Соответствие PCI DSS и локальным требованиям
- **Гибкость:** Быстрое добавление новых способов оплаты
- **Стоимость:** Выше на 0.5-1% чем single provider подход
- **Сложность:** Увеличение времени разработки на 30%
