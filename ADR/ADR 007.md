# ADR 007: Выбор стратегии обработки геолокации в реальном времени

**Дата:** 23 октября 2023 г.  
**Статус:** Принято  
**Участники:** Lead Backend Developer, Mobile Lead, DevOps Architect, Product Owner

---

## Контекст

Для Такси-сервиса необходимо определить стратегию обработки геолокации, которая обеспечит:

- **Обновление позиций водителей** каждые 5 секунд с минимальной задержкой
- **Поиск ближайших водителей** за <100ms для создания заказа
- **Масштабируемость** до 10,000 одновременно активных водителей
- **Эффективное хранение** истории перемещений для аналитики
- **Работу при нестабильном интернет-соединении** у водителей

**Критические требования:**

- **PER05:** Обновление позиции на карте с задержкой ≤3 секунд
- **SCA05:** Поддержка 10,000 активных водителей
- **Бизнес-требования:** Точность ETA ≤90%
- **Пользовательский опыт:** Плавное движение такси на карте

**Рассмотренные варианты:**

1. **WebSocket соединения** – низкая задержка, но высокое потребление ресурсов
2. **Long Polling** – проще в реализации, но выше latency
3. **Server-Sent Events (SSE)** – компромисс между сложностью и производительностью
4. **MQTT протокол** – оптимизирован для IoT, но требует специализированного брокера
5. **Гибридный подход** – разные протоколы для разных сценариев

---

## Решение

Выбран **гибридный подход**:

- **WebSocket для водителей** – низкая задержка обновления позиций
- **Server-Sent Events для клиентов** – эффективная передача обновлений позиций такси
- **MQTT для массовой рассылки уведомлений** – оптимизация broadcast операций
- **Redis GEO для spatial queries** – быстрый поиск ближайших водителей

---

## Обоснование

### 1. **Анализ протоколов для разных use cases**

|Use Case|Требования|Выбранный протокол|Обоснование|
|---|---|---|---|
|**Обновление позиции водителя**|Low latency, high frequency|WebSocket|Минимальная задержка, persistent connection|
|**Отслеживание такси клиентом**|Efficient, one-way updates|SSE|Проще чем WebSocket, подходит для one-way|
|**Уведомление всех водителей в зоне**|Broadcast, efficient|MQTT|Оптимизирован для pub/sub, low overhead|
|**Поиск ближайших водителей**|Spatial queries, fast|Redis GEO|Специализированные гео-команды|

### 2. **Архитектура системы геолокации**

#### **Входящий поток (водитель → система):**

1. Мобильное приложение водителя отправляет позицию через WebSocket
2. WebSocket сервер валидирует и обогащает данные
3. Позиция сохраняется в Redis GEO с ключом водителя
4. Событие публикуется в Kafka для дальнейшей обработки

#### **Исходящий поток (система → клиент):**

1. Клиент подключается через SSE к серверу обновлений
2. При изменении позиции его такси – событие отправляется через SSE
3. Клиент получает обновления с задержкой <3 секунд

#### **Поисковый поток (поиск водителей):**

1. Запрос на поиск водителей поступает в Geo Service
2. Сервис выполняет GEORADIUS запрос в Redis
3. Результаты фильтруются по бизнес-правилам
4. Возвращается список подходящих водителей

### 3. **Оптимизация производительности**

#### **WebSocket оптимизации:**

- Binary protocol вместо JSON для уменьшения размера сообщений
- Compression для больших payload
- Connection pooling и reuse
- Graceful degradation при проблемах с сетью

#### **Redis GEO оптимизации:**

- Sharding по географическим регионам
- Репликация для read-heavy workloads
- Оптимальный выбор радиуса поиска
- Индексация дополнительных атрибутов водителей

#### **Сетевые оптимизации:**

- CDN для статического контента карт
- GeoDNS для направления к ближайшему датацентру
- QoS маркировка трафика
- TCP tuning для мобильных сетей

### 4. **Обработка edge cases**

#### **Сценарий "Потеря связи у водителя":**

1. Detection через heartbeat механизм
2. Автоматический перевод в статус "офлайн" через 30 секунд
3. Уведомление клиента о проблеме с водителем
4. Поиск замены если поездка уже началась

#### **Сценарий "Неточные GPS данные":**

1. Фильтрация выбросов через алгоритмы smoothing
2. Использование дополнительных источников (сотовые вышки, WiFi)
3. Валидация скорости перемещения
4. Фолбэк на последнюю валидную позицию

### 5. **Масштабируемость и отказоустойчивость**

#### **Horizontal scaling:**

- WebSocket серверы за балансировщиком
- Redis Cluster для GEO данных
- Kafka для асинхронной обработки событий
- Stateless обработчики для простого масштабирования

#### **Disaster recovery:**

- Multi-region deployment
- Automatic failover между датацентрами
- Репликация критичных данных в реальном времени
- Регулярные disaster recovery тесты

---

## Недостатки решения

### 1. **Сложность реализации**

- Три разных протокола для управления
- Синхронизация состояния между компонентами
- Сложность отладки распределенных соединений

### 2. **Потребление ресурсов**

- Высокое количество одновременных соединений
- Постоянный трафик обновлений позиций
- Memory overhead для хранения connection state

### 3. **Мобильные ограничения**

- Батарея устройств при постоянных обновлениях
- Нестабильность мобильных сетей
- Разные реализации на iOS и Android

### 4. **Стоимость инфраструктуры**

- Высокие затраты на bandwidth
- Специализированное железо для WebSocket серверов
- Лицензии на коммерческие MQTT брокеры

---

## Последствия

### Технические:

1. **Архитектура:**
    
    - Dedicated WebSocket серверы на Go/Rust
    - Redis Cluster с GEO capabilities
    - MQTT брокер (EMQX или HiveMQ)
    - SSE серверы как часть основного приложения
    
2. **Инфраструктура:**
    
    - Load balancer с WebSocket support
    - CDN для статических карт
    - Multi-region deployment
    - Dedicated network для real-time трафика
    
3. **Мониторинг:**
    
    - Connection metrics (active, failed, latency)
    - GEO query performance
    - Message delivery success rate
    - End-to-end latency tracking
    

### Организационные:

1. **Команда:**
    
    - Real-time engineer (1 чел) – WebSocket/MQTT
    - Mobile network specialist (0.5 чел)
    - DevOps с опытом high-load real-time систем
    
2. **Процессы:**
    
    - Capacity planning под рост пользователей
    - Регулярные load testing
    - Мониторинг качества связи в разных регионах
    
3. **Бюджет:**
    
    - Инфраструктура: $2000-5000/мес при 10k водителей
    - Разработка: 8-12 недель на реализацию
    - Поддержка: 15-20% времени команды
    

### Бизнес-последствия:

- **Пользовательский опыт:** Плавное отслеживание такси
- **Надёжность:** Минимальные потери обновлений
- **Масштабируемость:** Поддержка быстрого роста
- **Глобализация:** Работа в разных регионах мира
- **Стоимость:** Высокие инфраструктурные расходы
- **Сложность:** Требует специализированной экспертизы
