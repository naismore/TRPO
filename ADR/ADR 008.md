# ADR 008: Выбор стратегии офлайн-работы для водителей и клиентов

**Дата:** 23 октября 2023 г.  
**Статус:** Принято  
**Участники:** Mobile Lead, Lead Backend Developer, Product Owner, UX Designer

---

## Контекст

Для Такси-сервиса необходимо определить стратегию офлайн-работы, которая обеспечит:

- **Возможность работы водителей** при нестабильном или отсутствующем интернет-соединении
- **Создание заказов клиентами** без немедленного подключения к интернету
- **Синхронизацию данных** при восстановлении соединения
- **Минимальную потерю данных** при сбоях связи
- **Единый пользовательский опыт** независимо от качества сети

**Критические требования:**

- **PER04:** Синхронизация при восстановлении связи ≤30 секунд
- **Бизнес-требования:** Нулевая потеря завершенных поездок
- **Пользовательский опыт:** Плавный переход между онлайн/офлайн режимами
- **Географические требования:** Работа в регионах с нестабильным покрытием

**Рассмотренные подходы:**

1. **Кэширование данных** – простота, но ограниченная функциональность
2. **Local-first архитектура** – данные сначала локально, затем синхронизация
3. **Оптимистичные обновления** – мгновенный UI feedback с отложенной синхронизацией
4. **Conflict-free replicated data types (CRDT)** – сложность, но автоматическое разрешение конфликтов
5. **Гибридный подход** – разные стратегии для разных типов данных

---

## Решение

Выбран **гибридный подход**:

- **Local-first для водителей** – все критические операции локально с deferred sync
- **Оптимистичные обновления для клиентов** – мгновенный feedback с фоновой синхронизацией
- **Priority-based sync queue** – приоритетная синхронизация важных данных
- **Conflict resolution rules** – четкие правила разрешения конфликтов

---

## Обоснование

### 1. **Анализ use cases для разных пользователей**

|Пользователь|Критические офлайн-операции|Выбранная стратегия|
|---|---|---|
|**Водитель**|Завершение поездки, статусы, навигация|Local-first с immediate persistence|
|**Клиент**|Создание заказа, редактирование профиля|Оптимистичные обновления|
|**Администратор**|Просмотр отчетов, управление|Только онлайн с кэшированием|

### 2. **Архитектура офлайн-режима**

#### **Слой хранения:**

- **SQLite для структурированных данных** (поездки, пользователи)
- **Key-Value Store для настроек и состояния**
- **File System для больших данных** (документы, логи)
- **In-memory cache для быстрого доступа**

#### **Слой синхронизации:**

- **Priority queue для операций** (высокий: платежи, средний: поездки, низкий: логи)
- **Exponential backoff при ошибках**
- **Resumable uploads для больших файлов**
- **Delta synchronization** только измененных данных

#### **Слой конфликт-резолюшн:**

- **Last write wins для метаданных**
- **Merge для списков и коллекций**
- **Manual resolution для финансовых операций**
- **Version vectors для отслеживания истории**

### 3. **Сценарии работы**

#### **Сценарий "Водитель завершает поездку офлайн":**

1. Данные поездки сохраняются локально в SQLite
2. Приложение показывает "ожидание синхронизации"
3. При восстановлении связи – автоматическая отправка
4. Подтверждение от сервера → очистка локальных данных

#### **Сценарий "Клиент создает заказ офлайн":**

1. Заказ создается локально с временным ID
2. Пользователь видит подтверждение
3. Фоновая синхронизация при появлении сети
4. Замена временного ID на постоянный

#### **Сценарий "Конфликт данных":**

1. Детектирование конфликта при синхронизации
2. Применение правил резолюции
3. Уведомление пользователя при необходимости
4. Запись в аудит-лог

#### **Метаданные синхронизации:**

- Timestamp последней успешной синхронизации
- Хэш локального состояния
- Количество pending операций
- Размер данных для синхронизации

### 5. **Ограничения и границы**

#### **Поддерживаемые операции офлайн:**

- ✅ Создание/завершение поездки
- ✅ Обновление профиля
- ✅ Просмотр истории
- ✅ Навигация (с предзагруженными картами)

#### **Не поддерживаемые офлайн:**

- ❌ Real-time tracking
- ❌ Поиск водителей
- ❌ Оплата (только предварительная)
- ❌ Изменение тарифов

#### **Ограничения по данным:**

- Максимальный размер офлайн-данных: 100MB
- Максимальное время офлайн-работы: 24 часа
- Максимальное количество pending операций: 100

---

## Недостатки решения

### 1. **Сложность реализации**

- Две параллельные логики (онлайн/офлайн)
- Механизмы разрешения конфликтов
- Тестирование всех возможных сценариев

### 2. **Потребление ресурсов устройства**

- Дополнительное место на диске
- Батарея для фоновой синхронизации
- Memory для хранения локальных данных

### 3. **Безопасность данных**

- Локальное хранение чувствительных данных
- Риск компрометации устройства
- Сложность шифрования локальных данных

### 4. **Поддержка и отладка**

- Сложность диагностики проблем синхронизации
- Воспроизведение специфичных сценариев
- Обновление логики на уже работающих устройствах

---

## Последствия

### Технические:

1. **Архитектура:**
    
    - Unified data layer абстрагирующий источник данных
    - Sync Manager управляющий очередями и конфликтами
    - Conflict Resolver с настраиваемыми правилами
    - Network Monitor для детектирования изменений состояния
    
2. **Инфраструктура:**
    
    - API поддержка bulk operations
    - Endpoint для проверки статуса синхронизации
    - Механизм принудительной синхронизации
    - Инструменты для отладки проблем
    
3. **Мониторинг:**
    
    - Метрики успешности синхронизации
    - Среднее время в офлайн–режиме
    - Количество конфликтов и их разрешение
    - Размер офлайн–данных на устройствах
    

### Организационные:

1. **Команда:**
    
    - Mobile engineer с опытом офлайн–приложений
    - QA engineer для тестирования edge cases
    - Support team обученная работе с проблемами синхронизации
    
2. **Процессы:**
    
    - Регулярное тестирование офлайн–сценариев
    - Мониторинг метрик синхронизации
    - Процедуры восстановления при массовых проблемах
    
3. **Бюджет:**
    
    - Разработка: 10–12 недель
    - Инфраструктура: дополнительные 20% к основным затратам
    - Поддержка: 15% времени mobile команды
    

### Бизнес-последствия:

- **Улучшение UX:** Работа в регионах с плохим покрытием
- **Увеличение конверсии:** Меньше потерянных заказов
- **Конкурентное преимущество:** Надежность при плохой связи
- **Лояльность водителей:** Возможность работать в любых условиях
- **Стоимость:** Значительные инвестиции в разработку
- **Сложность:** Повышенные требования к поддержке

---
