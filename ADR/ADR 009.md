# ADR 009: Стратегия graceful degradation и circuit breakers

**Дата:** 23 октября 2023 г.  
**Статус:** Принято  
**Участники:** Lead Backend Developer, DevOps Architect, SRE, Product Owner

---

## Контекст

Для Такси-сервиса необходимо определить стратегию graceful degradation, которая обеспечит:

- **Частичную работоспособность** при сбоях зависимых сервисов
- **Автоматическое восстановление** после временных проблем
- **Минимальное влияние на пользователей** при деградации системы
- **Защиту от каскадных сбоев** в распределенной системе
- **Прозрачную коммуникацию** о проблемах пользователям

**Критические требования:**

- **AVA01:** Доступность 99.9% даже при partial failures
- **Бизнес-требования:** Возможность создать заказ при любых условиях
- **Пользовательский опыт:** Понятные сообщения о проблемах
- **Операционные требования:** Автоматическое восстановление без ручного вмешательства

**Рассмотренные подходы:**

1. **Retry с exponential backoff** – простота, но риск усугубления проблем
2. **Circuit breakers** – защита от каскадных сбоев, но сложность настройки
3. **Bulkheads** – изоляция сбоев, но избыточность ресурсов
4. **Fallbacks и default values** – сохранение функциональности, но ограниченные возможности
5. **Гибридный подход** – комбинация паттернов для разных типов сбоев

---

## Решение

Выбран **гибридный подход**:

- **Circuit breakers для внешних зависимостей** – защита от сбоев платежных систем, картографических сервисов
- **Bulkheads для внутренних компонентов** – изоляция сбоев между модулями
- **Intelligent fallbacks** – умные заглушки сохраняющие максимум функциональности
- **Multi-level degradation** – постепенное снижение функциональности

---

## Обоснование

### 1. **Классификация сбоев и стратегий обработки**

|Тип сбоя|Пример|Стратегия|Fallback|
|---|---|---|---|
|**Внешний сервис недоступен**|Платежный шлюз|Circuit breaker|Кэшированные тарифы, отложенная оплата|
|**Внутренний компонент перегружен**|Геосервис|Bulkhead|Упрощенный поиск водителей|
|**Временная проблема сети**|База данных|Retry с backoff|Локальный кэш|
|**Критичный сбой**|Авторизация|Fast fail|Лимитированный доступ|

### 2. **Архитектура graceful degradation**

#### **Уровень 1: Client-side resilience**

- Экспоненциальная backoff для повторных запросов
- Локальный кэш для критичных данных
- Offline-first подход для мобильных приложений

#### **Уровень 2: Service resilience**

- Circuit breakers на всех исходящих вызовах
- Timeouts и deadline propagation
- Health checks и readiness probes

#### **Уровень 3: Infrastructure resilience**

- Load balancing с health checking
- Auto-scaling based on metrics
- Multi-region deployment

#### **Уровень 4: Business logic resilience**

- Feature flags для отключения проблемных функций
- Degradation levels с четкими правилами
- A/B тестирование fallback стратегий

### 3. **Реализация circuit breakers**

#### **Три состояния:**

1. **Closed:** Нормальная работа, мониторинг ошибок
2. **Open:** Быстрый fail при превышении threshold
3. **Half-open:** Пробные запросы для проверки восстановления

#### **Мониторинг:**

- Количество transition между состояниями
- Время в каждом состоянии
- Количество blocked запросов
- Причины открытия circuit breaker

### 4. **Стратегии fallback**

#### **Для платежной системы:**

- **Уровень 1:** Использование кэшированных тарифов
- **Уровень 2:** Расчет по формуле без проверки доступности
- **Уровень 3:** Фиксированная цена с последующим adjustment
- **Уровень 4:** Бесплатная поездка для VIP клиентов

#### **Для геосервиса:**

- **Уровень 1:** Упрощенный расчет расстояния
- **Уровень 2:** Использование последних известных позиций
- **Уровень 3:** Ручной выбор водителя диспетчером
- **Уровень 4:** Фиксированная цена за зону

#### **Для сервиса уведомлений:**

- **Уровень 1:** Отложенная отправка при восстановлении
- **Уровень 2:** Альтернативный канал (SMS вместо push)
- **Уровень 3:** Периодическая проверка статуса в приложении
- **Уровень 4:** Только critical уведомления

### 5. **Сценарии деградации**

#### **Сценарий "Платежный шлюз недоступен":**

1. Circuit breaker открывается после 5 failures
2. Заказы создаются с estimated price
3. Пользователь получает уведомление об отложенной оплате
4. При восстановлении – автоматическая обработка pending платежей

#### **Сценарий "Геосервис перегружен":**

1. Bulkhead ограничивает параллельные запросы
2. Упрощенный алгоритм поиска водителей
3. Увеличение estimated time arrival
4. Уведомление пользователей о возможных задержках

#### **Сценарий "Полная деградация":**

1. Активация maintenance mode
2. Только завершение активных поездок
3. Блокировка новых заказов
4. Прозрачная коммуникация через все каналы

---

## Недостатки решения

### 1. **Сложность реализации и тестирования**

- Множество состояний и переходов
- Сложность тестирования edge cases
- Воспроизведение реальных сбоев в тестовой среде

### 2. **Риск маскировки реальных проблем**

- Автоматические fallbacks могут скрывать баги
- Сложность диагностики корневых причин
- Накопление технического долга в fallback логике

### 3. **Бизнес-логическая сложность**

- Определение что можно деградировать, а что нет
- Баланс между надежностью и качеством сервиса
- Коммуникация с пользователями о проблемах

### 4. **Операционные overhead**

- Мониторинг множества метрик
- Настройка threshold для разных компонентов
- Регулярный review и tuning параметров

---

## Последствия

### Технические:

1. **Архитектура:**
    
    - Resilience framework (Resilience4j или Hystrix)
    - Centralized configuration management
    - Distributed tracing для анализа сбоев
    - Chaos engineering infrastructure
    
2. **Инфраструктура:**
    
    - Service mesh для управления трафиком
    - Advanced monitoring и alerting
    - Canary deployments и feature flags
    - Dark launch capability
    
3. **Мониторинг:**
    
    - SLO/SLI tracking для каждого сервиса
    - Error budget consumption
    - Circuit breaker состояния dashboard
    - Fallback activation metrics
    
### Организационные:

1. **Команда:**
    
    - SRE с фокусом на reliability
    - Chaos engineer для тестирования устойчивости
    - Product manager для определения приоритетов деградации
    
2. **Процессы:**
    
    - Регулярные game days по resilience
    - Post-mortem анализ всех инцидентов
    - Capacity planning с учетом деградации
    - Documentation degradation scenarios
    
3. **Бюджет:**
    
    - Инфраструктура: дополнительные 30% к базовой стоимости
    - Разработка: 8-10 недель на реализацию
    - Поддержка: 20% времени SRE команды
    

### Бизнес-последствия:

- **Надежность:** Сохранение работоспособности при сбоях
- **Лояльность пользователей:** Прозрачность при проблемах
- **Репутация:** Профессиональная обработка инцидентов
- **Конкурентное преимущество:** Высокая доступность
- **Сложность:** Значительные инвестиции в инфраструктуру
- **Качество:** Временное снижение при активации fallbacks
