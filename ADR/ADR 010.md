# ADR 010: Выбор стратегии мониторинга, алертинга и observability

**Дата:** 23 октября 2023 г.  
**Статус:** Принято  
**Участники:** Head of DevOps, SRE Lead, Lead Backend Developer, Product Owner

---

## Контекст

Для Такси-сервиса необходимо определить стратегию мониторинга и observability, которая обеспечит:

- **Прозрачность работы системы** в реальном времени
- **Раннее обнаружение проблем** до влияния на пользователей
- **Быстрое восстановление** при инцидентах
- **Понимание пользовательского опыта** на всех этапах
- **Анализ бизнес-метрик** для принятия решений

**Критические требования:**

- **MON01:** Использование стандартных инструментов мониторинга
- **AVA01:** Обнаружение проблем за <5 минут
- **Бизнес-требования:** Мониторинг ключевых бизнес-процессов (заказ→оплата→завершение)
- **Операционные требования:** Единая панель мониторинга для всей системы


**Рассмотренные подходы:**

1. **Метрики-логи-трейсы (Three Pillars)** – классический подход, но разрозненные данные
2. **APM-системы (Application Performance Monitoring)** – комплексно, но дорого и vendor lock-in
3. **OpenTelemetry-based observability** – открытый стандарт, но требует интеграции
4. **Business-centric monitoring** – фокус на бизнес-метриках, но недостаточно технических деталей
5. **Гибридный подход** – комбинация методов для разных аспектов системы

---

## Решение

Выбран **гибридный подход на основе OpenTelemetry**:

- **OpenTelemetry для телеметрии** – единый стандарт для метрик, логов и трейсов
- **Prometheus + Grafana для метрик** – стандарт индустрии, богатая экосистема
- **Loki + Tempo для логов и трейсов** – интегрированное решение от Grafana Labs
- **Synthetic monitoring для пользовательского опыта** – мониторинг ключевых пользовательских сценариев
- **Business metrics layer** – отдельный слой для бизнес-аналитики


---

## Обоснование

### **Компоненты мониторинга**

#### **Инфраструктурный мониторинг:**

- **Node exporters** для метрик серверов
- **cAdvisor** для контейнеров
- **Kube-state-metrics** для Kubernetes
- **Blackbox exporters** для сетевых проверок

#### **Прикладной мониторинг:**

- **Spring Boot Actuator** для Java/Kotlin приложений
- **Flutter metrics** для мобильных приложений
- **Database exporters** для PostgreSQL, Redis
- **Message queue exporters** для Kafka

#### **Бизнес-мониторинг:**

- **Key Business Metrics:** Заказы/час, Средний чек, Конверсия
- **User Journey Tracking:** Время от заказа до подачи такси
- **Quality Metrics:** Рейтинг водителей, Процент отмен
- **Financial Metrics:** Выручка, Комиссии, Chargeback rate

### **Стратегия алертинга**

#### **Уровни алертов:**

1. **Critical (P0):** Система недоступна, финансовые потери
    
    - Время реакции: 5 минут, 24/7
    - Канал: Phone call → SMS → Slack
    
2. **High (P1):** Деградация сервиса, влияет на пользователей
    
    - Время реакции: 15 минут, рабочее время
    - Канал: SMS → Slack → Email
    
3. **Medium (P2):** Потенциальные проблемы, не влияет на пользователей
    
    - Время реакции: 2 часа, рабочее время
    - Канал: Slack → Email
    
4. **Low (P3):** Информационные уведомления
    
    - Время реакции: 1 день
    - Канал: Email → Weekly report
    

### **Распределенное трейсинг (Distributed Tracing)**

#### **Ключевые трейсы:**

1. **Ride Creation Flow:** Клиент → API → Геосервис → Поиск водителя → Уведомление
2. **Payment Processing Flow:** Завершение поездки → Расчет стоимости → Платежный шлюз → Подтверждение
3. **Driver Matching Flow:** Новый заказ → Геопоиск → Фильтрация → Уведомление водителя

#### **Семплинг стратегия:**

- **Head-based sampling:** 100% для ошибок, 10% для успешных операций
- **Tail-based sampling:** Для анализа производительности по percentiles
- **Business-context sampling:** 100% для VIP клиентов

### **Synthetic Monitoring**

#### **Ключевые синтетические тесты:**

1. **E2E Ride Creation:** Создание заказа → Поиск водителя → Подтверждение
    
    - Частота: Каждые 5 минут
    - Регионы: Москва, СПб, регионы
    
2. **Payment Flow Test:** Тестовая оплата → Проверка статуса
    
    - Частота: Каждые 15 минут
    - Суммы: Минимальная, средняя, максимальная
    
3. **Real-user Monitoring:** Встраивание в мобильные приложения
    
    - Core Web Vitals для мобильных приложений
    - User timing marks для ключевых операций
    

---

## Недостатки решения

### 1. **Сложность настройки и поддержки**

- Множество компонентов для управления
- Интеграция между системами
- Обучение команды всем инструментам

### 2. **Объем данных и стоимость хранения**

- Высокий объем метрик, логов и трейсов
- Стоимость хранения и обработки
- Retention политики для разных типов данных

### 3. **Alert fatigue**

- Риск слишком большого количества алертов
- Настройка правильных threshold
- Постоянная калибровка правил

### 4. **Производительность overhead**

- Влияние инструментации на производительность приложений
- Network трафик для телеметрии
- Ресурсы для сбора и обработки данных

---

## Последствия

### Технические:

1. **Архитектура:**
    
    - OpenTelemetry Collector в каждом кластере
    - Centralized Grafana для визуализации
    - Alertmanager для управления алертами
    - Thanos/Cortex для долгосрочного хранения метрик
    
2. **Инфраструктура:**
    
    - Dedicated monitoring cluster
    - Object storage для долгосрочных данных
    - CDN для глобального доступа к дашбордам
    - Isolated network для безопасности
    
3. **Мониторинг самого мониторинга:**
    
    - Health checks всех компонентов
    - Пропускная способность коллекторов
    - Задержка алертов
    - Полнота данных
    

### Организационные:

1. **Команда:**
    
    - SRE/DevOps инженеры (2-3 чел)
    - Мониторинг специалист (1 чел)
    - On-call ротация для critical алертов
    - Обучение разработчиков инструментации
    
2. **Процессы:**
    
    - Регулярный review алертов (weekly)
    - Capacity planning для мониторинга
    - Disaster recovery для мониторинга
    - Security аудит конфигураций
    
3. **Бюджет:**
    
    - Инфраструктура: $2000-5000/мес
    - Лицензии: Grafana Enterprise при необходимости
    - Персонал: $180k/год
    - Хранение данных: $500-1000/мес
    

### Бизнес-последствия:

- **Быстрое обнаружение проблем:** MTTR снижение на 50%
- **Понимание пользовательского опыта:** Улучшение ключевых метрик
- **Data-driven решения:** Основа для принятия решений
- **Прогнозирование проблем:** Предсказание инцидентов
- **Стоимость:** Значительные инвестиции
- **Сложность:** Требует специализированной экспертизы

---
